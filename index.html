<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crash Runner - 3D Casino</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #0d1b38, #1e3c72);
            color: #fff;
            margin: 0;
            padding: 10px;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
        }
        #game-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(15px);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            max-width: 340px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
            text-align: center;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        #multiplier {
            font-size: 36px;
            font-weight: bold;
            color: #ffd700;
            margin: 10px 0;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
        }
        #status, #probability {
            font-size: 14px;
            margin: 5px 0;
            color: #d0e4ff;
            text-shadow: 0 0 5px rgba(208, 228, 255, 0.5);
        }
        #wallet {
            font-size: 14px;
            color: #00e676;
            margin: 5px 0;
            text-shadow: 0 0 5px rgba(0, 230, 118, 0.5);
        }
        #bet-container {
            margin: 10px 0;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        input[type="number"] {
            padding: 6px;
            font-size: 14px;
            width: 80px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }
        button {
            padding: 8px 15px;
            font-size: 14px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.3);
        }
        button:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        button#start {
            background: linear-gradient(45deg, #4caf50, #81c784);
        }
        button#cashout {
            background: linear-gradient(45deg, #ff9800, #ffb300);
        }
        button:disabled {
            background: #555;
            cursor: not-allowed;
            box-shadow: none;
        }
        #game-canvas {
            width: 100%;
            height: 200px;
            margin: 15px 0;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #history {
            font-size: 12px;
            color: #b0bec5;
            max-height: 70px;
            overflow-y: auto;
            margin-top: 10px;
            background: rgba(0, 0, 0, 0.1);
            padding: 5px;
            border-radius: 5px;
        }
        h1 {
            font-size: 20px;
            margin: 0 0 15px 0;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body>
    <div id="game-container">
        <h1>Crash Runner 3D</h1>
        <div id="wallet">Portefeuille : 100.00€</div>
        <div id="multiplier">1.00x</div>
        <div id="game-canvas"></div>
        <div id="status">Placez votre mise pour commencer.</div>
        <div id="probability">Probabilité de crash : 0%</div>
        <div id="bet-container">
            <label>Mise (€) : </label>
            <input type="number" id="bet" min="1" max="100" value="10">
        </div>
        <button id="start">Démarrer</button>
        <button id="cashout" disabled>Encaisser</button>
        <div id="history"></div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
    <script>
        let multiplier = 1.0;
        let isCrashed = false;
        let isRunning = false;
        let crashPoint = 0;
        let interval;
        let bet = 0;
        let winnings = 0;
        let wallet = 100.0;
        let gameCount = 0;
        let earlyCashouts = 0;
        let penaltyGames = 0;

        // Three.js Setup
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, 300 / 200, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(300, 200);
        document.getElementById("game-canvas").appendChild(renderer.domElement);
        renderer.setClearColor(0x0d1b38);

        // Éléments 3D
        let horse, rocket, ground, particles = [];
        let horseX = -5;
        let rocketY = 10;
        let explosion = false;

        // Lumière
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 5);
        scene.add(directionalLight);

        // Sol
        const groundGeometry = new THREE.PlaneGeometry(20, 20);
        const groundMaterial = new THREE.MeshLambertMaterial({ color: 0x4CAF50 });
        ground = new THREE.Mesh(groundGeometry, groundMaterial);
        ground.rotation.x = -Math.PI / 2;
        ground.position.y = -2;
        scene.add(ground);

        // Cheval
        const horseBodyGeometry = new THREE.BoxGeometry(1, 0.8, 0.4);
        const horseMaterial = new THREE.MeshPhongMaterial({ color: 0x5D4037, shininess: 50 });
        horse = new THREE.Mesh(horseBodyGeometry, horseMaterial);
        horse.position.set(horseX, -1.6, 0);

        const horseLegGeometry = new THREE.BoxGeometry(0.2, 0.6, 0.2);
        const legs = [];
        for (let i = 0; i < 4; i++) {
            legs[i] = new THREE.Mesh(horseLegGeometry, horseMaterial);
            legs[i].position.set(i % 2 === 0 ? -0.3 : 0.3, -1.9, i < 2 ? 0.1 : -0.1);
            horse.add(legs[i]);
        }
        scene.add(horse);

        // Fusée
        const rocketBodyGeometry = new THREE.CylinderGeometry(0.2, 0.3, 1.5, 32);
        const rocketMaterial = new THREE.MeshPhongMaterial({ color: 0xB0BEC5, shininess: 100 });
        rocket = new THREE.Mesh(rocketBodyGeometry, rocketMaterial);
        rocket.position.set(horseX, rocketY, 0);
        rocket.rotation.z = Math.PI;

        const rocketTipGeometry = new THREE.ConeGeometry(0.2, 0.5, 32);
        const rocketTipMaterial = new THREE.MeshPhongMaterial({ color: 0xF44336 });
        const rocketTip = new THREE.Mesh(rocketTipGeometry, rocketTipMaterial);
        rocketTip.position.y = 0.65;
        rocket.add(rocketTip);

        const finGeometry = new THREE.BoxGeometry(0.1, 0.4, 0.6);
        const finMaterial = new THREE.MeshPhongMaterial({ color: 0x78909C });
        const fin1 = new THREE.Mesh(finGeometry, finMaterial);
        fin1.position.set(0.35, 0, 0);
        rocket.add(fin1);
        const fin2 = new THREE.Mesh(finGeometry, finMaterial);
        fin2.position.set(-0.35, 0, 0);
        rocket.add(fin2);

        // Flammes (simples)
        const flameGeometry = new THREE.ConeGeometry(0.2, 0.5, 16);
        const flameMaterial = new THREE.MeshBasicMaterial({ color: 0xFF9800, transparent: true, opacity: 0.8 });
        const flame = new THREE.Mesh(flameGeometry, flameMaterial);
        flame.position.y = -0.65;
        rocket.add(flame);

        // Caméra
        camera.position.set(0, 2, 5);
        camera.lookAt(0, 0, 0);

        // Variables de contrôle
        const multiplierDisplay = document.getElementById("multiplier");
        const statusDisplay = document.getElementById("status");
        const probabilityDisplay = document.getElementById("probability");
        const walletDisplay = document.getElementById("wallet");
        const betInput = document.getElementById("bet");
        const startButton = document.getElementById("start");
        const cashoutButton = document.getElementById("cashout");
        const historyDisplay = document.getElementById("history");

        // Générer un crash truqué
        function generateCrashPoint() {
            gameCount++;
            if (penaltyGames > 0) {
                penaltyGames--;
                return 1.0;
            }

            const random = Math.random();
            if (gameCount === 1) return 20;
            if (gameCount === 2) return 15;
            if (random < 0.01 && gameCount > 10) return 100 + random * 20;
            if (random < 0.6) return 1.1 + random * 1.9;
            if (random < 0.9) return 3 + random * 2;
            return 5 + random * 5;
        }

        // Probabilité affichée
        function calculateCrashProbability() {
            const maxCrash = 120;
            return Math.min(100, ((multiplier - 1) / (maxCrash - 1)) * 70);
        }

        // Particules d’explosion
        function createExplosion(x, y, z) {
            explosion = true;
            for (let i = 0; i < 50; i++) {
                const particleGeometry = new THREE.SphereGeometry(Math.random() * 0.1 + 0.05, 16, 16);
                const particleMaterial = new THREE.MeshBasicMaterial({ color: Math.random() > 0.5 ? 0xFF9800 : 0xF44336 });
                const particle = new THREE.Mesh(particleGeometry, particleMaterial);
                particle.position.set(x, y, z);
                particle.velocity = new THREE.Vector3(
                    (Math.random() - 0.5) * 0.2,
                    (Math.random() - 0.5) * 0.2,
                    (Math.random() - 0.5) * 0.2
                );
                particle.life = 60;
                particles.push(particle);
                scene.add(particle);
            }
        }

        // Animation
        function animate() {
            requestAnimationFrame(animate);

            if (isRunning && !isCrashed) {
                horseX += 0.05;
                horse.position.x = horseX % 10 - 5;
                legs.forEach((leg, i) => {
                    leg.position.y = -1.9 + (Math.sin(horseX * 5 + (i % 2) * Math.PI) * 0.1);
                });
            }

            if (isCrashed && rocketY > -1.6) {
                rocketY -= 0.1;
                rocket.position.set(horse.position.x, rocketY, 0);
                flame.scale.set(1 + Math.random() * 0.2, 1 + Math.random() * 0.5, 1);
            }

            if (explosion) {
                particles.forEach(p => {
                    if (p.life > 0) {
                        p.position.add(p.velocity);
                        p.life--;
                        p.scale.setScalar(p.life / 60);
                    } else {
                        scene.remove(p);
                    }
                });
                particles = particles.filter(p => p.life > 0);
                if (particles.length === 0) explosion = false;
            }

            renderer.render(scene, camera);
        }
        animate();

        // Démarrer le jeu
        function startGame() {
            if (isRunning) return;

            bet = parseFloat(betInput.value);
            if (isNaN(bet) || bet <= 0 || bet > wallet) {
                alert("Mise invalide ou portefeuille insuffisant !");
                return;
            }

            wallet -= bet;
            walletDisplay.textContent = `Portefeuille : ${wallet.toFixed(2)}€`;
            multiplier = 1.0;
            isCrashed = false;
            isRunning = true;
            horseX = -5;
            rocketY = 10;
            explosion = false;
            particles.forEach(p => scene.remove(p));
            particles = [];
            crashPoint = generateCrashPoint();
            multiplierDisplay.textContent = "1.00x";
            statusDisplay.textContent = "Le cheval galope...";
            probabilityDisplay.textContent = "Probabilité de crash : 0%";
            startButton.disabled = true;
            cashoutButton.disabled = false;
            betInput.disabled = true;

            scene.add(rocket);

            interval = setInterval(() => {
                if (multiplier >= crashPoint) {
                    crash();
                } else {
                    multiplier += 0.05;
                    multiplierDisplay.textContent = `${multiplier.toFixed(2)}x`;
                    probabilityDisplay.textContent = `Probabilité de crash : ${calculateCrashProbability().toFixed(1)}%`;
                }
            }, 50);
        }

        // Gérer le crash
        function crash() {
            isCrashed = true;
            isRunning = false;
            clearInterval(interval);
            multiplierDisplay.textContent = `CRASH à ${crashPoint.toFixed(2)}x`;
            statusDisplay.textContent = crashPoint === 1.0 ? "Fusée explosive ! Oups !" : "Fusée crashée ! Réessaie ?";
            cashoutButton.disabled = true;
            startButton.disabled = false;
            betInput.disabled = false;

            setTimeout(() => {
                if (rocketY <= -1.6) {
                    scene.remove(horse);
                    createExplosion(horse.position.x, -1.6, 0);
                    setTimeout(() => {
                        horse = new THREE.Mesh(horseBodyGeometry, new THREE.MeshPhongMaterial({ color: 0xF44336 }));
                        horse.position.set(horseX % 10 - 5, -1.6, 0);
                        scene.add(horse);
                    }, 1500);
                }
            }, rocketY > -1.6 ? 2000 : 0);

            logResult(`Perdu - Mise: ${bet}€, Crash: ${crashPoint.toFixed(2)}x`);
            checkGameOver();
        }

        // Encaisser
        function cashOut() {
            if (!isRunning || isCrashed) return;

            clearInterval(interval);
            isRunning = false;
            winnings = bet * multiplier;
            wallet += winnings;
            walletDisplay.textContent = `Portefeuille : ${wallet.toFixed(2)}€`;
            statusDisplay.textContent = `Génial ! ${winnings.toFixed(2)}€ gagnés !`;

            if (multiplier < 1.5) {
                earlyCashouts++;
                if (earlyCashouts > 3) {
                    penaltyGames = 3;
                    earlyCashouts = 0;
                }
            }

            cashoutButton.disabled = true;
            startButton.disabled = false;
            betInput.disabled = false;
            horse.material.color.set(0xFFD700);
            scene.remove(rocket);
        }

        // Vérifier fin de jeu
        function checkGameOver() {
            if (wallet <= 0) {
                statusDisplay.textContent = "Portefeuille vide ! Merci d’avoir joué !";
                startButton.disabled = true;
                betInput.disabled = true;
            }
        }

        // Historique
        function logResult(message) {
            const entry = document.createElement("p");
            entry.textContent = message;
            historyDisplay.insertBefore(entry, historyDisplay.firstChild);
            if (historyDisplay.children.length > 5) {
                historyDisplay.removeChild(historyDisplay.lastChild);
            }
        }

        // Événements
        startButton.addEventListener("click", startGame);
        cashoutButton.addEventListener("click", cashOut);
    </script>
</body>
</html>